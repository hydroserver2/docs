# Deploying HydroServer to AWS and Timescale Cloud

This guide will walk you through how to set up and maintain a HydroServer deployment on AWS and Timescale Cloud services using Terraform and GitHub Actions. We recommend you familiarize yourself with AWS security best practices before setting up HydroServer in AWS.

## Fork the hydroserver-ops Repository
1. Fork the hydroserver-ops repository, which contains tools you'll use for managing your HydroServer deployments.
2. Go to your forked repository settings and navigate to "Environments".
3. Create a new environment with a simple name (e.g., beta, prod, dev), which you will use in subsequent steps. This new environment name will be used to identify various AWS and Timescale Cloud services.
4. Create an environment variable named DEBUG and set its value to 'True'. You can set it to 'False' for production environments.
5. Create an environment secret called DJANGO_SECRET_KEY and generate and store a Django secret key there.

## Create an AWS Account
1. Create an AWS account if you don't already have one.
2. Create an IAM account to manage HydroServer deployments, granting it the following permissions policies: AmazonS3FullAccess, AWSWAFFullAccess, CloudFrontFullAccess, and AdministratorAccess-AWSElasticBeanstalk. You can also create custom permissions policies if you need additional restrictions.
3. Generate an Access Key for the IAM user.
4. Create environment secrets in your GitHub environment called AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY for the IAM Access Key you just created. 
5. Manually create an S3 bucket named "hydroserver-terraform-backend" in your AWS account. Use the default settings and make sure it is not publicly accessible. Terraform will use this bucket to manage your deployments and store credentials you'll need to access later. 

## Set Up Timescale Cloud Account
1. Create a Timescale Cloud account and project. Take note of your project ID.
2. Under project settings, create a set of client credentials for your project.
3. Create environment secrets in GitHub called TIMESCALE_PROJECT_ID, TIMESCALE_ACCESS_KEY, and TIMESCALE_SECRET_KEY for the project and credentials you just created.

## Terraform Setup for AWS Services
1. From your hydroserver-ops repository, go to Actions > Workflows and click "Create HydroServer AWS Cloud Deployment".
2. Run the workflow and input the same environment name used for your GitHub environment.
3. The workflow will take several minutes to complete. Once complete, you should have an Elastic Beanstalk app and environment, a Cloudfront distribution, and several S3 buckets associated with your environment. At this point, these services will not have any HydroServer code deployed to them, but you can check the AWS Console to verify that they are running.

## Additional Environment Configuration
1. Retrieve the CloudFront distribution ID and domain name from the AWS CloudFront dashboard.
2. Create a GitHub environment secret called CLOUDFRONT_ID for the CloudFront ID.
3. Create an environment variable called ALLOWED_HOSTS and enter the CloudFront domain name. ALLOWED_HOSTS accepts a comma-separated list of domains Django will accept requests from, so you can also enter the autogenerated Elastic Beanstalk domain. If you're attaching a custom domain to your CloudFront distribution, you should enter that domain. For security reasons, you should limit ALLOWED_HOSTS to only domains you intend users to be able to access HydroServer from.
4. Create an environment variable called PROXY_BASE_URL and the the CloudFront domain name, including the protocol (e.g. https://). If you're using a custom domain instead of the CloudFront generated domain, use that base URL instead. Some pages and resources, such as the admin dashboard, will only work when accessed through this base URL. 
5. Using a Google account, follow the instructions [here](https://developers.google.com/maps/documentation/embed/get-api-key) to generate a Google Maps API key and map ID for your HydroServer environment.
6. Create GitHub environment secrets called GOOGLE_MAPS_API_KEY and GOOGLE_MAPS_MAP_ID for the Google Maps API key and map ID you just created.
   
## Timescale Cloud Database Setup
1. From your hydroserver-ops repo, click Actions > Workflows and select "Create HydroServer Timescale Cloud Database".
2. Run the workflow, providing your environment name, Django admin account credentials, and partition interval (default: 365 days). The Django credentials you provide will be used to create a superuser you can use to log in to the Django admin dashboard. You can change these later if you wish. The partition interval is used to chunk the HydroServer observations table. Depending on your data needs, you may want to adjust this value. You can read more about Timescale hypertables and paritioning [here](https://docs.timescale.com/use-timescale/latest/hypertables/about-hypertables/). Although Timescale Cloud uses a default partition interval of 7 days, the default used by the hydroserver-ops repo is 365 days.
3. Optionally specify a HydroServer version. If you want to use the latest version of HydroServer, leave this field blank.
4. After the workflow completes, you should see a new service on your Timescale Cloud dashboard. To connect to this service, retrieve the Timescale database connection details from the output folder in the hydroserver-terraform-backend S3 bucket you created earlier.
5. Create a GitHub environment secret called DATABASE_URL and store the database connection string from the connection details file.

## Google OAuth Settings
1. To enable Google OAuth for HydroServer account creation, follow the instructions [here](https://developers.google.com/identity/protocols/oauth2) to create client credentials for HydroServer.
2. Use the following pattern for the Google OAuth authorized redirect URL: {PROXY_BASE_URL}/api/account/google/auth
3. Create GitHub environment secrets called OAUTH_GOOGLE_CLIENT and OAUTH_GOOGLE_SECRET for the credentials you just created.

## ORCID OAuth Settings
1. To enable ORCID OAuth for HydroServer account creation, follow the instructions [here](https://info.orcid.org/documentation/api-tutorials/api-tutorial-get-and-authenticated-orcid-id/) to create client credentials for HydroServer.
2. Use the following pattern for the ORCID OAuth authorized redirect URL: {PROXY_BASE_URL}/api/account/orcid/auth
3. Create GitHub environment secrets called OAUTH_ORCID_CLIENT and OAUTH_ORCID_SECRET for the credentials you just created.

## HydoShare OAuth Settings
1. To enable HydroShare OAuth for HydroServer data archival, create a HydroShare account and use [this page](https://www.hydroshare.org/o/applications/) to create client credentials for HydroServer.
2. Use the following pattern for the HydroShare OAuth authorized redirect URL: {PROXY_BASE_URL}/api/account/hydroshare/auth
3. Create GitHub environment secrets called OAUTH_HYDROSHARE_CLIENT and OAUTH_HYDROSHARE_SECRET for the credentials you just created.

## Deploy HydroServer to AWS Cloud
1. From the hydroserver-ops repo, click Actions > Workflows and choose "Deploy HydroServer to AWS Cloud Deployment".
2. Run the workflow, entering the environment name.
3. Optionally specify a HydroServer version. If you want to use the latest version of HydroServer, leave this field blank.
4. After completion, your HydroServer instance should be running at the autogenerated CloudFront URL. You can log in to the admin dashboard at /admin/.

## Set Up a Custom HydroServer Domain
1. If you want to host HydroServer behind a custom domain, you can do so using [Route 53](https://aws.amazon.com/route53/) or another DNS provider.
2. Follow the instructions [here](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/CNAMEs.html) to host CloudFront behind your custom domain.
3. Remember to update your environment's PROXY_BASE_URL and ALLOWED_HOST settings accordingly.

## Updating HydroServer
1. If you want to update HydroServer, just rerun the workflow from the previous step.
2. This worflow handles code updates and database migrations, but you should check the release notes for the version you're updating to in case there are any additional steps required for that version.
3. Updated environment variables and secrets in GitHub will not be automatically applied to your deployment until you run this workflow. If you are redeploying a version of HydroServer you've already deployed, you will need to first delete that application version from Elastic Beanstalk or the deployment will fail. Most of these settings can also be modified through the Elastic Beanstalk dashboard configuration settings if you want to change any settings without redeploying through GitHub.
